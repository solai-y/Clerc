events {}

http {
  # Allowlist origins
  map $http_origin $cors_origin {
    default "";
    "~^http://localhost:3000$"                                           $http_origin;  # dev
    "~^https://clerc(-git-[a-z0-9-]+)?-solaiys-projects\.vercel\.app$"   $http_origin;  # vercel prod+previews
    "~^https://clerc\.uk$"                                               $http_origin;  # production domain
    "~^https://.*\.clerc\.uk$"                                           $http_origin;  # production subdomains
    "~^https://.*\.ec2\.amazonaws\.com$"                                 $http_origin;  # EC2 domains
    "~^https://.*\.compute\.amazonaws\.com$"                             $http_origin;  # EC2 compute domains
  }

  map $request_method $cors_methods { default "GET, POST, PUT, PATCH, DELETE, OPTIONS"; }
  map $request_method $cors_headers { default "Content-Type, Authorization, X-Requested-With"; }

  upstream company_service        { server company-service:5001; }
  upstream document_service       { server document-service:5002; }
  upstream s3_service             { server s3-service:5003; }
  upstream ai_service             { server ai-service:5004; }
  upstream llm_service            { server llm-service:5005; }
  upstream prediction_service     { server prediction-service:5006; }
  upstream text_extraction_service { server text-extraction-service:5008; }

  server {
    listen 80;
    client_max_body_size 100m;

    # -------- /company (match both /company and /company/...) --------
    location ^~ /company/ {
      proxy_pass http://company_service/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /documents (match both /documents and /documents/...) --------
    location ^~ /documents {
      proxy_pass http://document_service/documents;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /s3 (match both /s3 and /s3/...) --------
    location ^~ /s3/ {
      proxy_pass http://s3_service/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      client_max_body_size 100m;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /demo/ (static) --------
    location ^~ /demo/ {
      alias /usr/share/nginx/html/;
      autoindex on;

      # Match dev CORS/header format for consistency
      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /ai (match both /ai and /ai/...) --------
    location ^~ /ai/ {
      proxy_pass http://ai_service/;
      proxy_http_version 1.1;
      proxy_read_timeout 300s;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /llm (match both /llm and /llm/...) --------
    location ^~ /llm/ {
      proxy_pass http://llm_service/;
      proxy_http_version 1.1;
      proxy_read_timeout 300s;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /predict (exact match) --------
    location = /predict {
      proxy_pass http://prediction_service/;
      proxy_http_version 1.1;
      proxy_read_timeout 180s;  # Longer timeout for LLM calls
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /predict/ (with subpaths) --------
    location ^~ /predict/ {
      proxy_pass http://prediction_service/;
      proxy_http_version 1.1;
      proxy_read_timeout 180s;  # Longer timeout for LLM calls
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }

    # -------- /text-extract (match both /text-extract and /text-extract/...) --------
    location ^~ /text-extract {
      proxy_pass http://text_extraction_service/;
      proxy_http_version 1.1;
      proxy_read_timeout 120s;  # Longer timeout for PDF processing
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;

      proxy_hide_header Access-Control-Allow-Origin;
      proxy_hide_header Access-Control-Allow-Credentials;
      proxy_hide_header Access-Control-Allow-Headers;
      proxy_hide_header Access-Control-Allow-Methods;

      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Vary "Origin" always;
      add_header Access-Control-Allow-Methods $cors_methods always;
      add_header Access-Control-Allow-Headers $cors_headers always;

      if ($request_method = OPTIONS) { return 204; }
    }
  }
}
